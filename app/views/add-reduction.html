{% extends "includes/layout.html" %} 

{% block content %}

<main id="content" role="main">
  {% include "includes/breadcrumbs.html" %} 
  
  <header class="heading-xlarge" style="margin-top:0; margin-bottom:0">
    New reduction
  </header>

  {%if failureText %}
  <p class="message message--failure">{{ failureText }}</p>
  {% endif %}

  <p class="lede">Add a new reduction for <span class="bold">{{ title }}</span></p>
  {% set first = true %}
  <form action="/offender-manager/{{ linkId }}/add-reduction" method=POST id="reductionForm">
    <div class="form-group" id="reduction_reason_selection">
      <label class="form-label-bold" for="select-box">Reason for reduction</label>
      <select class="form-control" id="select-box" name="reasonForReductionId" onChange="populateHours(), calculateExpiry()">        
        <option value="" disabled selected>Please select a reason...</option>
        {% for reason in referenceData %}
        <option value="{{ reason.id }}">{{ reason.reasonShortName }}</option>
        {% else %}
        <option value="{{ reason.id }}">{{ reason.reasonShortName }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group" id="reduction_hours">
      <label class="form-label-bold" for="hours">Hours</label>
      <input class="form-control" id="hours" name="hours" type="number" style="width: 100px">
    </div>

    <div class="form-group" id="reduction_start_date">
      <fieldset>
        <legend>
          <span class="form-label-bold">Reduction start date</span>
          <span class="form-hint">For example, 31 3 1980</span>
        </legend>
        <div class="form-date" id="reduction_start_day">
          <div class="form-group form-group-day">
            <label class="form-label" for="start-day">Day</label>
            <input class="form-control" id="start-day" name="red_start_day" type="number" min="1" pattern="[+-]?[0-9]{1,2}" max="31" onchange="calculateExpiry()">
          </div>
          <div class="form-group form-group-month" id="reduction_start_month">
            <label class="form-label" for="start-month">Month</label>
            <input class="form-control" id="start-month" name="red_start_month" type="number" min="1" pattern="[+-]?[0-9]{1,2}" max="12" onchange="calculateExpiry()">
          </div>
          <div class="form-group form-group-year" id="reduction_start_year">
            <label class="form-label" for="start-year">Year</label>
            <input class="form-control" id="start-year" name="red_start_year" type="number" min="0" pattern="[+-]?[0-9]{1,4}" max="2099" onchange="calculateExpiry()">
          </div>
        </div>
      </fieldset>
    </div>

    <div class="form-group" id="reduction_end_date">
      <fieldset>
        <legend>
          <span class="form-label-bold">Reduction end date</span>
          <span class="form-hint">For example, 31 3 1980</span>
        </legend>
        <div class="form-date" id="reduction_end_day">
          <div class="form-group form-group-day">
            <label class="form-label" for="end-day">Day</label>
            <input class="form-control" id="end-day" name="red_end_day" type="number" pattern="[+-]?[0-9]{1,2}" min="1" max="31">
          </div>
          <div class="form-group form-group-month" id="reduction_end_month">
            <label class="form-label" for="end-month">Month</label>
            <input class="form-control" id="end-month" name="red_end_month" type="number" pattern="[+-]?[0-9]{1,2}" min="1" max="12">
          </div>
          <div class="form-group form-group-year" id="reduction_end_year">
            <label class="form-label" for="end-year">Year</label>
            <input class="form-control" id="end-year" name="red_end_year" type="number" pattern="[+-]?[0-9]{1,4}" min="0" max="">
          </div>
        </div>
      </fieldset>
    </div>

    <div class="form-group">
      <label class="form-label-bold" for="textarea">Additional notes</label>
      <textarea class="form-control form-control-3-4" name="notes" id="textarea" rows="5"></textarea>
    </div> 
    {% include "includes/csrf-hidden-input.html"%} 
    <input class="button" type="submit" value="Add reduction">
  </form>

</main>
{% endblock %} {% block body_end %}
<script type="text/javascript">
  var refData = {{ referenceData | dump | safe }}

  var chosenReduction

  var populateHours = function () {

    // Set current year dynamically
    var currentYear = new Date().getYear()
    document.getElementById('start-year').setAttribute('min', currentYear)

    var value = ''

    var chosenReductionIndex = document.getElementById("select-box").selectedIndex

    // Dummy option in dropdown means array is offset by one.
    chosenReduction = refData[chosenReductionIndex - 1]
    
    if (chosenReduction.allowancePercentage !== null) {
      document.getElementById('hours').value = chosenReduction.allowanceHours
      document.getElementById('hours').setAttribute('readonly', true)
    } else {
      document.getElementById('hours').value = value
      document.getElementById('hours').removeAttribute('readonly')
    }
    
    if (chosenReduction.maxAllowancePercentage !== null) {
      document.getElementById('hours').setAttribute('max', chosenReduction.maxAllowanceHours)
    }
  }

  var calculateExpiry = function () {    
    var chosenReductionIndex = document.getElementById("select-box").selectedIndex
    chosenReduction = refData[chosenReductionIndex]

    var startMonth = document.getElementById("start-month").value
    var readonly = false
    var endDate = null
    var startDate

    if (chosenReduction.monthsToExpiry !== null) {
      if (Number(startMonth) > 0 && Number(startMonth) < 13) {
        var startDate = new Date(Number(document.getElementById("start-year").value),
                                 Number(document.getElementById("start-month").value),
                                 Number(document.getElementById("start-day").value))
        var endDate = new Date(startDate.setMonth(startDate.getMonth() + chosenReduction.monthsToExpiry))
        readonly = true
      }
    }

    if (readonly){
      document.getElementById('end-day').setAttribute('readonly', readonly)
      document.getElementById('end-month').setAttribute('readonly', readonly)
      document.getElementById('end-year').setAttribute('readonly', readonly)
    } else {
      document.getElementById('end-day').removeAttribute('readonly')
      document.getElementById('end-month').removeAttribute('readonly')
      document.getElementById('end-year').removeAttribute('readonly')
    }
    if(endDate !== null) {
      document.getElementById('end-day').value = endDate.getDay()
      document.getElementById('end-month').value = endDate.getMonth()
      document.getElementById('end-year').value = endDate.getFullYear()
    } else {
      document.getElementById('end-day').value = ''
      document.getElementById('end-month').value = ''
      document.getElementById('end-year').value = ''
    }
  }

</script>
{% endblock %}